{% extends 'admin_dashboard/base.html' %}

{% block title %}Inventory - Admin{% endblock %}
{% block page_title %}Inventory Management{% endblock %}

{% block content %}
<!-- Summary Cards -->
<div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
    <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium">Total Fabric Colors</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="total-fabrics">0</h3>
            </div>
            <div class="w-14 h-14 rounded-full bg-purple-100 flex items-center justify-center">
                <i class="fas fa-palette text-purple-600 text-xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium">Low Stock Alerts</p>
                <h3 class="text-3xl font-bold text-red-600 mt-2" id="low-stock-count">0</h3>
            </div>
            <div class="w-14 h-14 rounded-full bg-red-100 flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-red-600 text-xl"></i>
            </div>
        </div>
    </div>

    <div class="bg-white rounded-xl p-6 card-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-500 text-sm font-medium">Out of Stock</p>
                <h3 class="text-3xl font-bold text-gray-800 mt-2" id="out-of-stock-count">0</h3>
            </div>
            <div class="w-14 h-14 rounded-full bg-gray-100 flex items-center justify-center">
                <i class="fas fa-times-circle text-gray-600 text-xl"></i>
            </div>
        </div>
    </div>
</div>

<!-- Bulk Update Section -->
<div class="bg-white rounded-xl p-6 card-shadow mb-8">
    <h3 class="text-lg font-semibold text-gray-800 mb-4">Bulk Update Inventory</h3>

    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
        <div class="col-span-2">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select Fabric Color</label>
            <select id="bulk-fabric-select" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">Choose fabric color...</option>
            </select>
        </div>

        <div>
            <label class="block text-sm font-medium text-gray-700 mb-2">New Quantity</label>
            <input type="number" id="bulk-quantity" min="0" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
        </div>

        <div class="flex items-end">
            <button onclick="addToBulkUpdate()" class="w-full px-4 py-2 gradient-bg text-white rounded-lg hover:opacity-90 transition">
                <i class="fas fa-plus mr-2"></i> Add to Batch
            </button>
        </div>
    </div>

    <!-- Bulk Update Queue -->
    <div id="bulk-update-queue" class="mt-4 space-y-2 hidden">
        <div class="flex items-center justify-between mb-2">
            <h4 class="font-medium text-gray-700">Update Queue (<span id="queue-count">0</span>)</h4>
            <button onclick="clearBulkQueue()" class="text-red-600 text-sm hover:text-red-700">
                Clear All
            </button>
        </div>
        <div id="queue-items" class="space-y-2"></div>
        <button onclick="executeBulkUpdate()" class="w-full px-4 py-3 gradient-bg text-white rounded-lg hover:opacity-90 transition font-medium">
            <i class="fas fa-check mr-2"></i> Update All (<span id="queue-count-btn">0</span> items)
        </button>
    </div>
</div>

<!-- Low Stock Alerts -->
<div class="bg-white rounded-xl p-6 card-shadow mb-8">
    <div class="flex items-center justify-between mb-4">
        <h3 class="text-lg font-semibold text-gray-800">Low Stock Alerts</h3>
        <select id="threshold-selector" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
            <option value="5">Threshold: 5</option>
            <option value="10" selected>Threshold: 10</option>
            <option value="15">Threshold: 15</option>
            <option value="20">Threshold: 20</option>
        </select>
    </div>

    <div id="low-stock-alerts" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
        <div class="text-center py-8 text-gray-500 col-span-full">
            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i>
            <p>Loading inventory...</p>
        </div>
    </div>
</div>

<!-- All Inventory Table -->
<div class="bg-white rounded-xl p-6 card-shadow">
    <div class="flex items-center justify-between mb-6">
        <h3 class="text-lg font-semibold text-gray-800">All Inventory</h3>

        <div class="flex items-center space-x-4">
            <input type="text" id="inventory-search" placeholder="Search fabrics..." class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">

            <select id="stock-filter" class="px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                <option value="">All Status</option>
                <option value="Critical">Critical (0)</option>
                <option value="Low">Low Stock</option>
                <option value="Adequate">Adequate</option>
            </select>
        </div>
    </div>

    <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
            <thead>
                <tr class="text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                    <th class="pb-4">Image</th>
                    <th class="pb-4">Fabric Type</th>
                    <th class="pb-4">Color</th>
                    <th class="pb-4">Quantity</th>
                    <th class="pb-4">Status</th>
                    <th class="pb-4">Usage</th>
                    <th class="pb-4">Price</th>
                    <th class="pb-4">Actions</th>
                </tr>
            </thead>
            <tbody id="inventory-tbody" class="divide-y divide-gray-200">
            </tbody>
        </table>
    </div>
</div>

<!-- Inventory History Modal -->
<div id="history-modal" class="fixed inset-0 bg-black bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-xl p-8 max-w-3xl w-full mx-4 max-h-[90vh] overflow-y-auto">
        <div class="flex items-center justify-between mb-6">
            <h3 class="text-2xl font-bold text-gray-800">Inventory History</h3>
            <button onclick="closeHistoryModal()" class="text-gray-400 hover:text-gray-600">
                <i class="fas fa-times text-2xl"></i>
            </button>
        </div>

        <div id="history-content">
            <!-- Will be populated by JavaScript -->
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    let allInventory = [];
    let bulkUpdateQueue = [];

    // Fetch inventory status
    async function fetchInventory() {
        try {
            const threshold = document.getElementById('threshold-selector').value;
            const response = await fetch(`/purchase/analytics/inventory-status/?low_stock_threshold=${threshold}`);
            const data = await response.json();

            allInventory = data.data;
            updateInventoryStats(data);
            renderInventoryTable();
            renderLowStockAlerts(threshold);
            populateFabricSelector();
        } catch (error) {
            console.error('Error fetching inventory:', error);
        }
    }

    // Update inventory stats
    function updateInventoryStats(data) {
        document.getElementById('total-fabrics').textContent = data.total_fabrics;
        const lowStock = data.data.filter(item => item.status === 'Low').length;
        const outOfStock = data.data.filter(item => item.status === 'Critical').length;
        document.getElementById('low-stock-count').textContent = lowStock;
        document.getElementById('out-of-stock-count').textContent = outOfStock;
    }

    // Render low stock alerts
    async function renderLowStockAlerts(threshold) {
        try {
            const response = await fetch(`/design/inventory/low-stock/?threshold=${threshold}`);
            const data = await response.json();

            const container = document.getElementById('low-stock-alerts');

            if (data.low_stock_count === 0) {
                container.innerHTML = `
                    <div class="text-center py-8 text-gray-500 col-span-full">
                        <i class="fas fa-check-circle text-green-500 text-4xl mb-2"></i>
                        <p>No low stock items!</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = data.fabrics.map(fabric => `
                <div class="border border-${fabric.current_quantity === 0 ? 'red' : 'yellow'}-300 rounded-lg p-4 bg-${fabric.current_quantity === 0 ? 'red' : 'yellow'}-50">
                    ${fabric.cover ? `<img src="${fabric.cover}" class="w-full h-32 object-cover rounded-lg mb-3">` : ''}
                    <h4 class="font-semibold text-gray-800">${fabric.fabric_type_name}</h4>
                    <p class="text-sm text-gray-600">${fabric.color_name}</p>
                    <div class="mt-3 flex items-center justify-between">
                        <span class="text-2xl font-bold ${fabric.current_quantity === 0 ? 'text-red-600' : 'text-yellow-600'}">
                            ${fabric.current_quantity}
                        </span>
                        <button onclick="quickUpdate(${fabric.id}, '${fabric.fabric_type_name} - ${fabric.color_name}')" class="px-3 py-1 gradient-bg text-white rounded text-sm">
                            Restock
                        </button>
                    </div>
                </div>
            `).join('');
        } catch (error) {
            console.error('Error fetching low stock alerts:', error);
        }
    }

    // Render inventory table
    function renderInventoryTable() {
        const tbody = document.getElementById('inventory-tbody');
        const searchTerm = document.getElementById('inventory-search').value.toLowerCase();
        const statusFilter = document.getElementById('stock-filter').value;

        let filtered = allInventory.filter(item => {
            const matchesSearch = !searchTerm ||
                item.fabric_type.toLowerCase().includes(searchTerm) ||
                item.color_name.toLowerCase().includes(searchTerm);

            const matchesStatus = !statusFilter || item.status === statusFilter;

            return matchesSearch && matchesStatus;
        });

        tbody.innerHTML = filtered.map(item => `
            <tr class="hover:bg-gray-50">
                <td class="py-4">
                    <div class="w-12 h-12 bg-gray-200 rounded-lg"></div>
                </td>
                <td class="py-4">
                    <span class="font-medium text-gray-800">${item.fabric_type}</span>
                </td>
                <td class="py-4">
                    <span class="text-gray-600">${item.color_name}</span>
                </td>
                <td class="py-4">
                    <span class="text-2xl font-bold ${item.status === 'Critical' ? 'text-red-600' : item.status === 'Low' ? 'text-yellow-600' : 'text-green-600'}">
                        ${item.quantity}
                    </span>
                </td>
                <td class="py-4">
                    <span class="px-3 py-1 rounded-full text-xs font-medium ${item.status === 'Critical' ? 'bg-red-100 text-red-700' : item.status === 'Low' ? 'bg-yellow-100 text-yellow-700' : 'bg-green-100 text-green-700'}">
                        ${item.status}
                    </span>
                </td>
                <td class="py-4">
                    <span class="text-gray-600">${item.usage_count} orders</span>
                </td>
                <td class="py-4">
                    <span class="font-medium text-gray-800">${item.price.toFixed(3)} KWD</span>
                </td>
                <td class="py-4">
                    <div class="flex items-center space-x-2">
                        <button onclick="quickUpdate(${item.id}, '${item.fabric_type} - ${item.color_name}')" class="text-purple-600 hover:text-purple-700" title="Quick Update">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button onclick="viewHistory(${item.id})" class="text-blue-600 hover:text-blue-700" title="View History">
                            <i class="fas fa-history"></i>
                        </button>
                    </div>
                </td>
            </tr>
        `).join('');
    }

    // Populate fabric selector
    function populateFabricSelector() {
        const select = document.getElementById('bulk-fabric-select');
        select.innerHTML = '<option value="">Choose fabric color...</option>' +
            allInventory.map(item => `
                <option value="${item.id}" data-name="${item.fabric_type} - ${item.color_name}" data-current="${item.quantity}">
                    ${item.fabric_type} - ${item.color_name} (Current: ${item.quantity})
                </option>
            `).join('');
    }

    // Quick update
    function quickUpdate(fabricId, fabricName) {
        const newQty = prompt(`Update quantity for ${fabricName}:`, '0');
        if (newQty === null) return;

        bulkUpdateQueue.push({
            fabric_color_id: fabricId,
            quantity: parseInt(newQty),
            notes: 'Quick update from inventory page'
        });

        updateBulkQueueDisplay();
    }

    // Add to bulk update
    function addToBulkUpdate() {
        const select = document.getElementById('bulk-fabric-select');
        const quantity = document.getElementById('bulk-quantity').value;

        if (!select.value || !quantity) {
            alert('Please select a fabric and enter quantity');
            return;
        }

        const selectedOption = select.options[select.selectedIndex];

        bulkUpdateQueue.push({
            fabric_color_id: parseInt(select.value),
            quantity: parseInt(quantity),
            name: selectedOption.dataset.name,
            currentQty: selectedOption.dataset.current,
            notes: 'Bulk update'
        });

        select.value = '';
        document.getElementById('bulk-quantity').value = '';

        updateBulkQueueDisplay();
    }

    // Update bulk queue display
    function updateBulkQueueDisplay() {
        const queueDiv = document.getElementById('bulk-update-queue');
        const queueItems = document.getElementById('queue-items');

        if (bulkUpdateQueue.length === 0) {
            queueDiv.classList.add('hidden');
            return;
        }

        queueDiv.classList.remove('hidden');
        document.getElementById('queue-count').textContent = bulkUpdateQueue.length;
        document.getElementById('queue-count-btn').textContent = bulkUpdateQueue.length;

        queueItems.innerHTML = bulkUpdateQueue.map((item, index) => `
            <div class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                <div>
                    <p class="font-medium text-gray-800">${item.name || `Fabric #${item.fabric_color_id}`}</p>
                    <p class="text-sm text-gray-500">
                        ${item.currentQty ? `Current: ${item.currentQty} → ` : ''}New: ${item.quantity}
                    </p>
                </div>
                <button onclick="removeFromQueue(${index})" class="text-red-600 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            </div>
        `).join('');
    }

    // Remove from queue
    function removeFromQueue(index) {
        bulkUpdateQueue.splice(index, 1);
        updateBulkQueueDisplay();
    }

    // Clear bulk queue
    function clearBulkQueue() {
        bulkUpdateQueue = [];
        updateBulkQueueDisplay();
    }

    // Execute bulk update
    async function executeBulkUpdate() {
        if (bulkUpdateQueue.length === 0) return;

        if (!confirm(`Update ${bulkUpdateQueue.length} fabric colors?`)) return;

        try {
            const response = await fetch('/design/inventory/bulk-update/', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ updates: bulkUpdateQueue })
            });

            const data = await response.json();

            if (response.ok) {
                alert(`Successfully updated ${data.updated.length} items!`);
                clearBulkQueue();
                fetchInventory();
            } else {
                alert('Some updates failed. Check console for details.');
                console.error(data);
            }
        } catch (error) {
            console.error('Error executing bulk update:', error);
            alert('Failed to update inventory');
        }
    }

    // View history
    async function viewHistory(fabricColorId) {
        try {
            const response = await fetch(`/design/inventory/history/${fabricColorId}/`);
            const data = await response.json();

            const content = document.getElementById('history-content');
            content.innerHTML = `
                <div class="mb-6 p-4 bg-gray-50 rounded-lg">
                    <h4 class="font-semibold text-gray-800 mb-2">${data.fabric_color.name}</h4>
                    <p class="text-sm text-gray-600">Current Quantity: <span class="font-bold text-2xl text-purple-600">${data.fabric_color.current_quantity}</span></p>
                </div>

                <div class="space-y-3">
                    ${data.transactions.map(tx => `
                        <div class="flex items-start p-4 border border-gray-200 rounded-lg">
                            <div class="w-10 h-10 rounded-full ${
                                tx.transaction_type === 'ORDER' ? 'bg-red-100' :
                                tx.transaction_type === 'CANCEL' ? 'bg-green-100' :
                                tx.transaction_type === 'RESTOCK' ? 'bg-blue-100' : 'bg-gray-100'
                            } flex items-center justify-center mr-4">
                                <i class="fas ${
                                    tx.transaction_type === 'ORDER' ? 'fa-shopping-cart text-red-600' :
                                    tx.transaction_type === 'CANCEL' ? 'fa-undo text-green-600' :
                                    tx.transaction_type === 'RESTOCK' ? 'fa-box text-blue-600' : 'fa-edit text-gray-600'
                                }"></i>
                            </div>
                            <div class="flex-1">
                                <div class="flex items-center justify-between mb-1">
                                    <span class="font-medium text-gray-800">${tx.transaction_type}</span>
                                    <span class="text-sm text-gray-500">${new Date(tx.timestamp).toLocaleString()}</span>
                                </div>
                                <p class="text-sm text-gray-600">
                                    ${tx.quantity_before} → ${tx.quantity_after}
                                    <span class="${tx.quantity_change > 0 ? 'text-green-600' : 'text-red-600'} font-medium">
                                        (${tx.quantity_change > 0 ? '+' : ''}${tx.quantity_change})
                                    </span>
                                </p>
                                ${tx.reference_order ? `<p class="text-xs text-gray-500 mt-1">Order: ${tx.reference_order}</p>` : ''}
                                ${tx.notes ? `<p class="text-xs text-gray-500 mt-1">${tx.notes}</p>` : ''}
                                <p class="text-xs text-gray-400 mt-1">By: ${tx.created_by}</p>
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;

            document.getElementById('history-modal').classList.remove('hidden');
            document.getElementById('history-modal').classList.add('flex');
        } catch (error) {
            console.error('Error fetching inventory history:', error);
        }
    }

    // Close history modal
    function closeHistoryModal() {
        document.getElementById('history-modal').classList.add('hidden');
        document.getElementById('history-modal').classList.remove('flex');
    }

    // Event listeners
    document.getElementById('threshold-selector').addEventListener('change', fetchInventory);
    document.getElementById('inventory-search').addEventListener('input', renderInventoryTable);
    document.getElementById('stock-filter').addEventListener('change', renderInventoryTable);

    // Initial load
    fetchInventory();
</script>
{% endblock %}
